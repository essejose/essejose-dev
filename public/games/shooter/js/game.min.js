const canvas=document.getElementById("game");canvas.addEventListener("touchstart",handleTouch),canvas.addEventListener("touchmove",handleTouch);const ctx=canvas.getContext("2d");function handleTouch(e){e.preventDefault();const t=e.touches[0],i=canvas.getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top;game.player.targetX=s-game.player.width/2,game.player.targetY=a-game.player.height/2}function resizeCanvas(){canvas.width=window.innerWidth,canvas.height=window.innerHeight;try{window.game&&window.game.parallaxLayers&&window.game.parallaxLayers.forEach((e=>e.updateScale()))}catch(e){}}resizeCanvas(),window.addEventListener("resize",resizeCanvas);const ASSETS={helicopter:"./images/player.png",inimigo1:"./images/inimigos/inimigo1.png",inimigo2:"./images/inimigos/inimigo2.png",tank:"./images/inimigos/tank.png",grass:"https://placehold.co/20x20/418753/000?text=-",health:"https://placehold.co/20x20/ff66cc/000?text=H",parallax1:"./images/parallax-2/6.png",parallax2:"./images/parallax-2/5.png",parallax3:"./images/parallax-2/4.png",parallax4:"./images/parallax-2/3.png",parallax5:"./images/parallax-2/2.png",parallax6:"./images/parallax-2/1.png"},IMAGES={},CONTROLSMODES={HELICOPTER:"helicopter",PLANE:"plane"};let keys={},controlMode=CONTROLSMODES.PLANE;function loadImages(e,t){let i=0;const s=Object.keys(e).length;for(const a in e)IMAGES[a]=new Image,IMAGES[a].src=e[a],IMAGES[a].onload=()=>{i++,i===s&&t()}}document.addEventListener("keydown",(e=>{keys[e.code]=!0,"KeyM"===e.code&&(controlMode=controlMode===CONTROLSMODES.HELICOPTER?CONTROLSMODES.PLANE:CONTROLSMODES.HELICOPTER,window.game&&window.game.parallaxLayers&&window.game.parallaxLayers.forEach((e=>e.updateSpeed(controlMode)))),"KeyK"===e.code&&(game.debug=!game.debug,console.log("Debug mode:",game.debug?"ON":"OFF"))})),document.addEventListener("keydown",(e=>keys[e.code]=!0)),document.addEventListener("keyup",(e=>keys[e.code]=!1));class ParallaxLayer{constructor(e,t,i=0){this.image=e,this.baseSpeed=t,this.speed=t,this.y=i,this.x1=0,this.x2=0,this.updateScale()}updateScale(){this.image&&this.image.width&&(this.scaleY=canvas.height/this.image.height,this.scaleX=this.scaleY,this.scaledWidth=this.image.width*this.scaleX,this.scaledHeight=canvas.height,this.x2=this.scaledWidth)}updateSpeed(e){const t=e===CONTROLSMODES.HELICOPTER?.5:1;this.speed=this.baseSpeed*t}update(){this.x1-=this.speed,this.x2-=this.speed,this.x1+this.scaledWidth<=0&&(this.x1=this.x2+this.scaledWidth),this.x2+this.scaledWidth<=0&&(this.x2=this.x1+this.scaledWidth)}draw(e){this.image&&this.image.complete&&(e.drawImage(this.image,this.x1,this.y,this.scaledWidth,this.scaledHeight),e.drawImage(this.image,this.x2,this.y,this.scaledWidth,this.scaledHeight))}reset(){this.updateScale(),this.x1=0,this.x2=this.scaledWidth}}class ComboSystem{constructor(){this.combo=0,this.comboTimer=0,this.comboTimeout=180,this.multiplier=1,this.maxCombo=0,this.pulseScale=1}addKill(){this.combo++,this.comboTimer=this.comboTimeout,this.multiplier=1+.1*this.combo,this.combo>this.maxCombo&&(this.maxCombo=this.combo),this.pulseScale=1.5,5===this.combo?game.damageTexts.push(new DamageText(canvas.width/2,100,"ðŸ”¥ COMBO x5!","orange")):10===this.combo?game.damageTexts.push(new DamageText(canvas.width/2,100,"âš¡ COMBO x10!","yellow")):20===this.combo?game.damageTexts.push(new DamageText(canvas.width/2,100,"ðŸ’¥ COMBO x20!","red")):50===this.combo?game.damageTexts.push(new DamageText(canvas.width/2,100,"ðŸŒŸ LEGENDARY!","gold")):this.combo%10==0&&this.combo>20&&game.damageTexts.push(new DamageText(canvas.width/2,100,`ðŸ’« COMBO x${this.combo}!`,"gold"))}reset(){this.combo=0,this.multiplier=1,this.comboTimer=0}update(){this.comboTimer>0?this.comboTimer--:this.combo>0&&(this.combo>=5&&game.damageTexts.push(new DamageText(canvas.width/2,150,"COMBO PERDIDO!","gray")),this.reset()),this.pulseScale>1&&(this.pulseScale-=.05,this.pulseScale<1&&(this.pulseScale=1))}getScoreMultiplier(){return Math.floor(10*this.multiplier)/10}draw(e){if(0===this.combo)return;const t=canvas.width-180;let i="white";this.combo>=50?i="gold":this.combo>=20?i="#ff6b6b":this.combo>=10?i="#ffd93d":this.combo>=5&&(i="orange"),e.save(),e.translate(t,150),e.scale(this.pulseScale,this.pulseScale),e.fillStyle=i,e.strokeStyle="black",e.lineWidth=3,e.font="bold 20px Arial",e.strokeText("COMBO",-30,0),e.fillText("COMBO",-30,0),e.font="bold 48px Arial",e.strokeText(`x${this.combo}`,-30,45),e.fillText(`x${this.combo}`,-30,45),e.restore(),e.fillStyle="white",e.font="16px Arial",e.fillText(`Multiplicador: x${this.getScoreMultiplier()}`,t-30,220);const s=t-30;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(s,230,150,8);const a=this.comboTimer/this.comboTimeout;let h="#4CAF50";a<.3?h="#ff4444":a<.6&&(h="#ffaa00"),e.fillStyle=h,e.fillRect(s,230,150*a,8),e.strokeStyle="white",e.lineWidth=2,e.strokeRect(s,230,150,8)}}class CountdownSystem{constructor(){this.active=!1,this.count=2,this.timer=0,this.callback=null,this.message=""}start(e,t="GET READY!"){this.active=!0,this.count=2,this.timer=60,this.callback=e,this.message=t}update(){this.active&&(this.timer--,this.timer<=0&&(this.count--,this.count<0?(this.active=!1,this.callback&&this.callback()):this.timer=60))}draw(e){if(!this.active)return;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,canvas.width,canvas.height),this.message&&(e.fillStyle="#FFD700",e.strokeStyle="black",e.lineWidth=4,e.font="bold 36px Arial",e.textAlign="center",e.textBaseline="middle",e.strokeText(this.message,canvas.width/2,canvas.height/2-80),e.fillText(this.message,canvas.width/2,canvas.height/2-80));const t=1+this.timer/60*.3;e.save(),e.translate(canvas.width/2,canvas.height/2),e.scale(t,t),this.count>0?(e.fillStyle="#FF4444",e.strokeStyle="black",e.lineWidth=6,e.font="bold 120px Arial",e.textAlign="center",e.textBaseline="middle",e.strokeText(this.count.toString(),0,0),e.fillText(this.count.toString(),0,0)):(e.fillStyle="#00FF00",e.strokeStyle="black",e.lineWidth=6,e.font="bold 80px Arial",e.textAlign="center",e.textBaseline="middle",e.strokeText("READY!",0,0),e.fillText("READY!",0,0)),e.restore()}}const MAX_COINS_ON_SCREEN=50;class CoinDrop{constructor(e,t,i=1){this.x=e,this.y=t,this.value=i,this.width=20,this.height=20,this.vx=2*(Math.random()-.5),this.vy=-2-2*Math.random(),this.gravity=.2,this.bounce=.5,this.lifetime=300,this.maxLifetime=300,this.collected=!1,this.pulseTime=0,this.pulseSpeed=.1}update(){this.vy+=this.gravity,this.x+=this.vx,this.y+=this.vy,this.vx*=.98;const e=canvas.height-.1*canvas.height-this.height;this.y>=e&&(this.y=e,this.vy*=-this.bounce,this.vx*=.8,Math.abs(this.vy)<.5&&(this.vy=0)),this.x-=1,this.pulseTime+=this.pulseSpeed,this.lifetime--;const t=game.player.x-this.x,i=game.player.y-this.y,s=Math.sqrt(t*t+i*i);if(s<100){const e=.3;this.x+=t/s*e*10,this.y+=i/s*e*10}}draw(e){const t=1+.2*Math.sin(this.pulseTime);let i=1;this.lifetime<60?i=Math.floor(this.lifetime/5)%2==0?1:.3:this.lifetime<120&&(i=.5+(this.lifetime-60)/120*.5),e.save(),e.globalAlpha=i,e.translate(this.x+this.width/2,this.y+this.height/2),e.scale(t,t);let s="#FFD700";this.value>=10?s="#FF69B4":this.value>=5&&(s="#00CED1"),e.fillStyle=s,e.strokeStyle="#FFA500",e.lineWidth=2,e.beginPath(),e.arc(0,0,this.width/2,0,2*Math.PI),e.fill(),e.stroke(),e.fillStyle="#000",e.font="bold 14px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText("â­",0,0),this.value>1&&(e.fillStyle="#FFF",e.strokeStyle="#000",e.lineWidth=2,e.font="bold 10px Arial",e.strokeText(this.value,0,-8),e.fillText(this.value,0,-8)),e.restore()}get dead(){return this.lifetime<=0||this.x<-50||this.collected}}const HitEffectManager={spawnEffect(e,t,i="spark",s=1){switch(i){case"spark":for(let i=0;i<4*s;i++)game.particles.push(new ExplosionParticle(e,t,"yellow"));break;case"explosion":for(let i=0;i<10*s;i++){const i=Math.random()<.5?"orange":"red";game.particles.push(new ExplosionParticle(e,t,i))}game.shakeX=4*s,game.shakeY=3*s;break;case"laser":for(let i=0;i<6*s;i++)game.particles.push(new ExplosionParticle(e,t,"cyan"));break;case"hitPlayer":for(let i=0;i<4;i++)game.particles.push(new ExplosionParticle(e,t,"white"));game.shakeX=2;break;default:console.warn("Efeito desconhecido:",i)}}},WeaponTypes={BASIC:{speed:8,damage:2,color:"red",name:"BASIC",cooldown:15,isAuxiliary:!1,hitEffect:"spark",wobbleY:.8},SPREAD:{speed:7,damage:2,spread:!0,color:"orange",name:"SPREAD",cooldown:20,isAuxiliary:!1,hitEffect:"spark"},BURST:{speed:10,damage:2,color:"yellow",name:"BURST",cooldown:8,burst:!0,burstCount:3,burstDelay:5,isAuxiliary:!1,hitEffect:"spark"},LASER:{speed:12,damage:3,color:"lime",name:"LASER",cooldown:5,isAuxiliary:!1,hitEffect:"laser"},MISSILE:{speed:6,damage:4,color:"blue",name:"MISSILE",cooldown:40,homing:!0,isAuxiliary:!1,hitEffect:"explosion"}},AuxiliaryWeaponTypes={MISSILE:{speed:7,damage:3,color:"blue",name:"MISSILE",cooldown:50,homing:!0,isAuxiliary:!0,hitEffect:"explosion"},ORBITAL:{name:"ORBITAL",color:"cyan",cooldown:60,speed:6,damage:2,isAuxiliary:!0,orbit:!0,hitEffect:"spark"},MINE:{speed:6,damage:4,color:"black",name:"MINE",cooldown:80,isAuxiliary:!0,hitEffect:"explosion"},TURRET:{name:"TURRET",color:"orange",cooldown:40,speed:8,damage:2,isAuxiliary:!0,turret:!0,hitEffect:"spark"},SHIELD:{name:"SHIELD",color:"purple",cooldown:180,damage:0,isAuxiliary:!0,shield:!0,hitEffect:"spark"},BEAM:{name:"BEAM",color:"#FFD700",cooldown:30,speed:12,damage:1,isAuxiliary:!0,beam:!0,hitEffect:"spark"}};class ProximityMineProjectile{constructor(e,t,i=4,s=50){this.x=e,this.y=t,this.damage=i,this.radius=s,this.width=12,this.height=12,this.timer=300,this.armed=!1,this.armDelay=30,this.blinkCounter=0}draw(){if(this.armed){const e=Math.floor(this.blinkCounter/10)%2==0;ctx.fillStyle=e?"red":"yellow"}else ctx.fillStyle="gray";ctx.beginPath(),ctx.arc(this.x,this.y,this.width/2,0,2*Math.PI),ctx.fill(),this.armed&&(ctx.strokeStyle="rgba(255,0,0,0.3)",ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.stroke())}update(){if(this.armDelay>0?this.armDelay--:this.armed=!0,this.timer--,this.blinkCounter++,this.armed){for(let e of game.enemies){const t=Math.max(e.x,Math.min(this.x,e.x+e.width)),i=Math.max(e.y,Math.min(this.y,e.y+e.height)),s=this.x-t,a=this.y-i;if(s*s+a*a<this.radius*this.radius)return void this.explode()}this.timer<=0&&this.explode()}}explode(){game.damageTexts.push(new DamageText(this.x,this.y,"ðŸ’¥","red"));for(let e of game.enemies){const t=Math.max(e.x,Math.min(this.x,e.x+e.width)),i=Math.max(e.y,Math.min(this.y,e.y+e.height)),s=this.x-t,a=this.y-i;s*s+a*a<this.radius*this.radius&&e.takeDamage&&e.takeDamage(this.damage)}this.dead=!0;for(let e=0;e<15;e++)game.particles.push(new ExplosionParticle(this.x,this.y,Math.random()<.5?"orange":"gray"))}}class ExplosionParticle{constructor(e,t,i="orange",s=1){this.x=e,this.y=t;const a=Math.random()*Math.PI*2,h=4*Math.random()+2;if(this.vx=Math.cos(a)*h,this.vy=Math.sin(a)*h,this.alpha=1,this.radius=(2+3*Math.random())*s,this.maxLife=20+20*Math.random(),this.life=this.maxLife,this.gravity=.1,this.friction=.98,"orange"===i){const e=["#FF4500","#FF6347","#FF8C00","#FFD700","#FFA500","#FF0000","#FFFFFF","#FFFF00"];this.color=e[Math.floor(Math.random()*e.length)]}else this.color=i}update(){this.vx*=this.friction,this.vy*=this.friction,this.vy+=this.gravity,this.x+=this.vx,this.y+=this.vy,this.life--,this.alpha=Math.max(0,this.life/this.maxLife),this.radius*=.96}draw(e=ctx){e.save(),e.globalAlpha=this.alpha,e.shadowBlur=10,e.shadowColor=this.color,e.fillStyle=this.color,e.beginPath(),e.arc(this.x,this.y,this.radius,0,2*Math.PI),e.fill(),e.restore()}get dead(){return this.life<=0}}function createExplosion(e,t,i=1,s=20){for(let a=0;a<s;a++)game.particles.push(new ExplosionParticle(e,t,"orange",i));game.particles.push({x:e,y:t,radius:5*i,life:5,maxLife:5,color:"#FFFFFF",update(){this.life--,this.radius*=1.5},draw(){const e=this.life/this.maxLife;ctx.save(),ctx.globalAlpha=.7*e,ctx.fillStyle=this.color,ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI),ctx.fill(),ctx.restore()},get dead(){return this.life<=0}})}class OrbitalDrone{constructor(e,t,i){this.player=e,this.angle=t,this.radius=50,this.weapon=i,this.cooldown=0}update(e,t){this.angle+=.02;const i=this.player.x+this.player.width/2,s=this.player.y+this.player.height/2;if(this.x=i+Math.cos(this.angle)*this.radius,this.y=s+Math.sin(this.angle)*this.radius,this.cooldown<=0){this.weapon.speed;game.projectiles.push(new Projectile(this.x,this.y,this.weapon));const e=1-.1*game.upgrades.fireRate;this.cooldown=this.weapon.cooldown*e}else this.cooldown--}draw(){ctx.fillStyle=this.weapon.color||"cyan",ctx.beginPath(),ctx.arc(this.x,this.y,6,0,2*Math.PI),ctx.fill()}}class WeaponInstance{constructor(e,t=1){this.type=e,this.level=t,this.damage=e.damage+(t-1),this.cooldown=Math.max(5,e.cooldown-(t-1)),this.cooldownCounter=0,this.spread=e.spread||!1,this.homing=e.homing||!1,this.color=e.color,this.name=e.name,this.speed=e.speed}levelUp(){this.level++,this.damage++,this.cooldown=Math.max(5,this.type.cooldown-(this.level-1))}readyToShoot(){return this.cooldownCounter<=0}updateCooldown(e){let t=1;e?.rapidFireTimer>0&&(t=2),this.cooldownCounter>0&&(this.cooldownCounter-=t)}resetCooldown(){this.cooldownCounter=this.cooldown}}const DropTypes={LIFE:{name:"LIFE",color:"green",apply(e){e.health<e.maxHealth&&(e.health++,game.damageTexts.push(new DamageText(e.x,e.y,"+1 HP","green")))}},SHIELD:{name:"SHIELD",color:"cyan",apply(e){e.invincibilityTimer=240,game.damageTexts.push(new DamageText(e.x,e.y,"Shield!","cyan"))}},BOMB:{name:"BOMB",color:"red",apply(e){const t=game.enemies.length;game.enemies=[],game.projectiles=game.projectiles.filter((e=>!e.homing)),game.damageTexts.push(new DamageText(e.x,e.y,`ðŸ’£ ${t} enemies`,"red"))}},SPEED:{name:"SPEED",color:"orange",apply(e){e.speedBoost=1.5,e.speedBoostTimer=300,game.damageTexts.push(new DamageText(e.x,e.y,"Speed!","orange"))}},RAPID:{name:"RAPID",color:"magenta",apply(e){e.rapidFireTimer=300,game.damageTexts.push(new DamageText(e.x,e.y,"Rapid Fire!","magenta"))}}};class DropInstance{constructor(e,t,i){this.x=e,this.y=t,this.width=20,this.height=20,this.dropType=i}draw(){ctx.fillStyle=this.dropType.color,ctx.fillRect(this.x,this.y,this.width,this.height),ctx.fillStyle="black",ctx.font="12px Arial",ctx.fillText(this.dropType.name[0],this.x+6,this.y+14)}update(){this.x-=2}apply(e){this.dropType.apply(e)}}function createWeapon(e,t=1){return new WeaponInstance(WeaponTypes[e],t)}class WeaponPowerUp{constructor(e,t,i){this.x=e,this.y=t,this.width=20,this.height=20,this.weaponType=i}draw(){ctx.fillStyle=this.weaponType.color,ctx.fillRect(this.x,this.y,this.width,this.height)}update(){this.x-=2}apply(e){if(e.primaryWeapon.name===this.weaponType.name)e.primaryWeapon.levelUp();else{console.log(this.weaponType);if(!0===this.weaponType.isAuxiliary){const t=e.auxiliaryWeapons.find((e=>e.name===this.weaponType.name));t?t.levelUp():e.auxiliaryWeapons.length<5&&(e.auxiliaryWeapons.push(new WeaponInstance(this.weaponType)),game.damageTexts.push(new DamageText(this.x,this.y,"New Auxiliary Weapon","gray")))}}}}class PowerUp{constructor(e,t){this.x=e,this.y=t,this.width=20,this.height=20,this.vx=2*(Math.random()-.5),this.vy=-3-2*Math.random(),this.gravity=.2,this.bounce=.4,this.lifetime=600}draw(){ctx.drawImage(IMAGES.health,this.x,this.y,this.width,this.height)}update(){this.vy+=this.gravity,this.x+=this.vx,this.y+=this.vy,this.vx*=.98;const e=canvas.height-.1*canvas.height-this.height;this.y>=e&&(this.y=e,this.vy*=-this.bounce,this.vx*=.8,Math.abs(this.vy)<.5&&(this.vy=0)),this.x-=1,this.lifetime--;const t=game.player.x-this.x,i=game.player.y-this.y,s=Math.sqrt(t*t+i*i);if(s<100){const e=.2;this.x+=t/s*e*10,this.y+=i/s*e*10}}get dead(){return this.lifetime<=0||this.x<-50}}class Player{constructor(){this.x=100,this.y=.5*canvas.height,this.width=80,this.height=80,this.velocity=0,this.gravity=.3,this.lift=-.6,this.cooldown=0,this.airborne=!0,this.maxHealth=5,this.health=this.maxHealth,this.invincible=!1,this.invincibilityTimer=0,this.speed=8,this.rapidFireTimer=0,this.orbitalDrones=[],this.shieldActive=!1,this.shieldTimer=0,this.targetX=null,this.targetY=null,this.moveSpeed=.15,this.tiltAngle=0,this.maxTilt=.15,this.tiltSpeed=.1,this.prevX=this.x,this.smokeParticles=[],this.smokeTimer=0,this.prevY=this.y,this.isDying=!1,this.deathTimer=0,this.deathVelocity=0,this.deathRotation=0,this.deathRotationSpeed=0,this.exploded=!1,this.knockbackX=0,this.knockbackY=0,this.propellerAngle=0,this.propellerSpeed=.3,this.propellerRadius=8,this.mainRotorAngle=0,this.mainRotorSpeed=.2,this.mainRotorRadius=30,this.primaryWeapon=new WeaponInstance(WeaponTypes.BASIC),this.auxiliaryWeapons=[]}draw(){this.smokeParticles.forEach((e=>e.draw(ctx))),ctx.save();const e=this.x+this.width/2,t=this.y+this.height/2;if(ctx.translate(e,t),ctx.rotate(this.tiltAngle),ctx.translate(-e,-t),this.invincible&&Math.floor(this.invincibilityTimer/5)%2==0&&(ctx.globalAlpha=.5),ctx.drawImage(IMAGES.helicopter,this.x,this.y,this.width,this.height),ctx.globalAlpha=1,this.drawPropeller(),this.drawMainRotor(),ctx.restore(),this.shieldActive&&this.shieldTimer>0){const e=Math.max(this.width,this.height)/2+15,t=this.x+this.width/2,i=this.y+this.height/2,s=3*Math.sin(Date.now()/100);ctx.save(),ctx.strokeStyle="rgba(138, 43, 226, 0.6)",ctx.lineWidth=4,ctx.setLineDash([10,5]),ctx.beginPath(),ctx.arc(t,i,e+s,0,2*Math.PI),ctx.stroke(),ctx.setLineDash([]),ctx.restore();const a=60,h=4,o=this.x,n=this.y-20,l=this.shieldTimer/180;ctx.fillStyle="rgba(138, 43, 226, 0.3)",ctx.fillRect(o,n,a,h),ctx.fillStyle="rgba(138, 43, 226, 0.8)",ctx.fillRect(o,n,a*l,h)}const i=this.x,s=this.y-12,a=this.health/this.maxHealth;let h;ctx.fillStyle="rgba(0, 0, 0, 0.5)",ctx.fillRect(i,s,60,8),h=a<=.15?Math.floor(Date.now()/200)%2==0?"#ff0000":"#cc0000":a<=.3?"#ff4400":a<=.5?"#ffcc00":"#00ff00",ctx.fillStyle=h,ctx.fillRect(i,s,60*a,8),ctx.strokeStyle="black",ctx.lineWidth=2,ctx.strokeRect(i,s,60,8),this.orbitalDrones&&this.orbitalDrones.forEach((e=>e.draw()))}drawPropeller(){const e=this.x+this.width/27,t=this.y+this.height/2.7;ctx.save(),ctx.translate(e,t),ctx.rotate(this.propellerAngle),ctx.strokeStyle="#333",ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(-this.propellerRadius,0),ctx.lineTo(this.propellerRadius,0),ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,-this.propellerRadius),ctx.lineTo(0,this.propellerRadius),ctx.stroke(),ctx.fillStyle="#666",ctx.beginPath(),ctx.arc(0,0,.5,0,2*Math.PI),ctx.fill(),ctx.restore()}drawMainRotor(){const e=this.x+47,t=this.y+25;ctx.save(),ctx.translate(e,t);const i=.3+.5*Math.abs(Math.sin(2*this.mainRotorAngle));ctx.globalAlpha=i,ctx.strokeStyle="#444",ctx.lineWidth=4,ctx.beginPath(),ctx.moveTo(-this.mainRotorRadius,0),ctx.lineTo(-2,0),ctx.stroke(),ctx.beginPath(),ctx.moveTo(2,0),ctx.lineTo(this.mainRotorRadius,0),ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,2,0,2*Math.PI),ctx.fillStyle="#555",ctx.fill(),ctx.globalAlpha=1,ctx.restore()}die(){this.isDying=!0,this.deathTimer=0,this.deathVelocity=-3,this.deathRotationSpeed=.1,this.exploded=!1}updateDeath(){if(!this.isDying)return!1;if(this.deathTimer++,this.deathVelocity+=.4,this.y+=this.deathVelocity,this.x-=2,this.deathRotation+=this.deathRotationSpeed,this.deathRotationSpeed+=.005,this.deathTimer%2==0){const e=this.x+this.width/2+30*(Math.random()-.5),t=this.y+this.height/2+30*(Math.random()-.5);this.smokeParticles.push(new SmokeParticle(e,t))}const e=canvas.height-.1*canvas.height;return this.y+this.height>=e&&!this.exploded&&(this.exploded=!0,createExplosion(this.x+this.width,e,20,15),this.deathTimer=0),!!(this.exploded&&this.deathTimer>60)}drawDeath(){if(this.isDying&&(this.smokeParticles.forEach((e=>e.draw(ctx))),!this.exploded)){ctx.save();const e=this.x+this.width/2,t=this.y+this.height/2;ctx.translate(e,t),ctx.rotate(this.deathRotation),ctx.translate(-e,-t),Math.floor(this.deathTimer/3)%2==0&&(ctx.globalAlpha=.8),ctx.drawImage(IMAGES.helicopter,this.x,this.y,this.width,this.height),ctx.globalAlpha=1,ctx.restore()}}takeDamage(e,t,i){this.health-=e,this.invincibilityTimer=180;const s=this.x+this.width/2-t,a=this.y+this.height/2-i,h=Math.sqrt(s*s+a*a);h>0&&(this.knockbackX=s/h*15,this.knockbackY=a/h*15);const o=this.x+this.width/2,n=this.y+this.height/2;for(let e=0;e<8;e++)game.particles.push(new ImpactParticle(o,n));game.shakeX=3,game.shakeY=3,game.damageTexts.push(new DamageText(this.x,this.y,"-"+e.toFixed(1),"red")),this.health<=0&&this.die()}update(){if(0===this.knockbackX&&0===this.knockbackY||(this.x+=this.knockbackX,this.y+=this.knockbackY,this.knockbackX*=.8,this.knockbackY*=.8,Math.abs(this.knockbackX)<.1&&(this.knockbackX=0),Math.abs(this.knockbackY)<.1&&(this.knockbackY=0)),null!==this.targetX&&null!==this.targetY){const e=this.targetX-this.x,t=this.targetY-this.y;this.x+=e*this.moveSpeed,this.y+=t*this.moveSpeed,Math.abs(e)<2&&Math.abs(t)<2&&(this.x=this.targetX,this.y=this.targetY,this.targetX=null,this.targetY=null)}this.propellerAngle+=this.propellerSpeed,this.mainRotorAngle+=this.mainRotorSpeed;const e=this.x-this.prevX,t=this.y-this.prevY;let i=0;if(e>.5?i=this.maxTilt:e<-.5&&(i=.5*-this.maxTilt),t<-.5?i+=.3*this.maxTilt:t>.5&&(i-=.3*this.maxTilt),this.tiltAngle+=(i-this.tiltAngle)*this.tiltSpeed,this.prevX=this.x,this.prevY=this.y,controlMode===CONTROLSMODES.HELICOPTER){(keys.Space||keys.ArrowUp||keys.KeyW)&&(this.velocity+=this.lift),this.velocity+=this.gravity,this.y+=this.velocity;const e=canvas.height-this.height-.1*canvas.height;if(this.y>=e?(this.y=e,this.velocity=0,this.airborne=!1):this.airborne=!0,this.y<0&&(this.y=0,this.velocity=0),this.airborne){const e=.3*this.speed;(keys.ArrowLeft||keys.KeyA)&&(this.x-=e),(keys.ArrowRight||keys.KeyD)&&(this.x+=e),this.x<0&&(this.x=0),this.x+this.width>canvas.width&&(this.x=canvas.width-this.width)}}else if(controlMode===CONTROLSMODES.PLANE){const e=this.speed*(this.speedBoost||1);(keys.ArrowUp||keys.KeyW)&&(this.y-=e),(keys.ArrowDown||keys.KeyS)&&(this.y+=e),(keys.ArrowLeft||keys.KeyA)&&(this.x-=e),(keys.ArrowRight||keys.KeyD)&&(this.x+=e);const t=canvas.height-this.height-.1*canvas.height;this.y>=t&&(this.y=t),this.y<0&&(this.y=0),this.x<0&&(this.x=0),this.x+this.width>canvas.width&&(this.x=canvas.width-this.width)}this.primaryWeapon.updateCooldown(this),this.primaryWeapon.readyToShoot()&&(this.shoot(),this.primaryWeapon.resetCooldown()),this.auxiliaryWeapons.forEach((e=>{e.updateCooldown(this),e.readyToShoot()&&(this.fireWeapon(e),e.resetCooldown())})),this.speedBoostTimer>0&&(this.speedBoostTimer--,this.speedBoostTimer<=0&&(this.speedBoost=1)),this.rapidFireTimer>0&&this.rapidFireTimer--,this.cooldown>0&&this.cooldown--,this.invincibilityTimer>0?(this.invincibilityTimer--,this.invincible=!0):this.invincible=!1,this.shieldTimer>0&&(this.shieldTimer--,this.shieldTimer<=0&&(this.shieldActive=!1)),this.orbitalDrones||(this.orbitalDrones=[]);const s=this.auxiliaryWeapons.filter((e=>"ORBITAL"===e.name));if(s.length>0){const e=s[0],t=Math.min(e.level,4);for(;this.orbitalDrones.length<t;)this.orbitalDrones.push(new OrbitalDrone(this,Math.random()*Math.PI*2,e));for(;this.orbitalDrones.length>t;)this.orbitalDrones.pop();this.orbitalDrones.forEach(((e,i)=>e.update(i,t)))}const a=this.health/this.maxHealth;if(a<=.3&&a>0){this.smokeTimer++;const e=a<.15?3:6;if(this.smokeTimer>=e){const e=this.x+22,t=this.y+this.height/2+20*(Math.random()-.5);this.smokeParticles.push(new SmokeParticle(e,t)),this.smokeTimer=0}}this.smokeParticles.forEach((e=>e.update())),this.smokeParticles=this.smokeParticles.filter((e=>!e.dead))}shoot(){if(this.cooldown<=0){if(this.primaryWeapon.type.burst){const e=this.primaryWeapon.type.burstCount||3,t=this.primaryWeapon.type.burstDelay||5;for(let i=0;i<e;i++)setTimeout((()=>{this.fireWeapon(this.primaryWeapon)}),i*t*16)}else this.fireWeapon(this.primaryWeapon);this.cooldown=this.primaryWeapon.cooldown}}fireWeapon(e){const t=this.y+this.height/2;if("MINE"!==e.name){if("TURRET"===e.name)return game.projectiles.push(new Projectile(this.x+this.width,t,e,0)),game.projectiles.push(new Projectile(this.x+this.width,t,e,-3)),void game.projectiles.push(new Projectile(this.x+this.width,t,e,3));if("BEAM"===e.name){const t=this.y,i=this.y+this.height;return game.projectiles.push(new Projectile(this.x+this.width,t,e,0)),void game.projectiles.push(new Projectile(this.x+this.width,i,e,0))}if("SHIELD"!==e.name)if(e.spread){const i=[-2,0,2];for(let s of i)game.projectiles.push(new Projectile(this.x+this.width,t,e,s))}else game.projectiles.push(new Projectile(this.x+this.width,t,e));else this.shieldActive||(this.shieldActive=!0,this.shieldTimer=180)}else{const t=this.x+this.width+20,i=this.y+this.height/2;game.projectiles.push(new ProximityMineProjectile(t,i,e.damage))}}}class Projectile{constructor(e,t,i,s=0){this.x=e,this.y=t,this.speed=i.speed;const a=1+.2*game.upgrades.damage;this.damage=i.damage*a,this.color=i.color,this.weaponName=i.name,this.width=10,this.height=3,this.verticalOffset=s,this.homing=i.homing||!1,this.lifetime=300,this.wobbleY=i.wobbleY||0,this.baseY=this.y,this.frameCount=0,this.vx=this.speed,this.vy=s,this.homing&&(this.target=null)}draw(){ctx.fillStyle=this.color,ctx.fillRect(this.x,this.y,this.width,this.height)}update(){if(this.homing){if(this.lifetime--,this.lifetime<=0&&(this.dead=!0),!this.target||this.target.health<=0||this.target.x+this.target.width<0){const e=game.enemies.filter((e=>e.x>game.player.x&&e.health>0)).sort(((e,t)=>e.x-t.x))[0];if(!e)return this.x+=this.vx,this.y+=this.vy,void this.checkOutOfBounds();this.target=e}const e=this.target.x+this.target.width/2-this.x,t=this.target.y+this.target.height/2-this.y,i=Math.sqrt(e*e+t*t)||1;this.vx=e/i*this.speed,this.vy=t/i*this.speed,this.x+=this.vx,this.y+=this.vy}else if(this.x+=this.speed,this.frameCount++,this.wobbleY){const e=(Math.random()-.5)*this.wobbleY*2;this.y+=e}else this.y+=this.verticalOffset;this.checkOutOfBounds()}checkOutOfBounds(){(this.x>canvas.width||this.x+this.width<0||this.y<0||this.y>canvas.height)&&(this.dead=!0)}}class EnemyProjectile{constructor(e,t,i=1){this.x=e,this.y=t,this.speed=4,this.width=8,this.height=3,this.damage=i}draw(){ctx.fillStyle="purple",ctx.fillRect(this.x,this.y,this.width,this.height)}update(){this.x-=this.speed}}class EnemyProjectileAngular{constructor(e,t,i,s,a=2){this.x=e,this.y=t;const h=i-e,o=s-t,n=Math.sqrt(h*h+o*o);this.vx=h/n*4,this.vy=o/n*4,this.width=8,this.height=3,this.damage=a}draw(){ctx.fillStyle="orange",ctx.fillRect(this.x,this.y,this.width,this.height)}update(){this.x+=this.vx,this.y+=this.vy}}class WobbleMovement{constructor(e={}){this.speed=e.speed||2,this.wobbleSpeed=e.wobbleSpeed||.06,this.wobbleAmplitude=e.wobbleAmplitude||15,this.wobbleOffset=Math.random()*Math.PI*2,this.wobbleCounter=0}update(e){e.x-=this.speed,this.wobbleCounter+=this.wobbleSpeed,e.y=e.baseY+Math.sin(this.wobbleCounter+this.wobbleOffset)*this.wobbleAmplitude}}class FlameEmitter{constructor(e={}){this.particles=[],this.spawnCounter=0,this.spawnRate=e.spawnRate||3,this.particleCount=e.particleCount||[2,3],this.offsetX=e.offsetX||0,this.offsetY=e.offsetY||0}update(e){if(this.spawnCounter++,this.spawnCounter>=this.spawnRate){this.spawnCounter=0;const t=e.x+e.width+this.offsetX,i=e.y+e.height/2+this.offsetY,s=this.particleCount[0],a=this.particleCount[1],h=Math.floor(Math.random()*(a-s+1))+s;for(let e=0;e<h;e++)this.particles.push(new FlameParticle(t,i+10*(Math.random()-.5)))}this.particles.forEach((e=>e.update())),this.particles=this.particles.filter((e=>!e.dead))}draw(){this.particles.forEach((e=>e.draw()))}}class WeaponComponent{constructor(e={}){this.damage=e.damage||1,this.cooldown=120*Math.random()+60,this.cooldownMin=e.cooldownMin||60,this.cooldownMax=e.cooldownMax||180}update(e){this.cooldown--,this.cooldown<=0&&(this.fire(e),this.cooldown=Math.random()*(this.cooldownMax-this.cooldownMin)+this.cooldownMin)}fire(e){game.enemyProjectiles.push(new EnemyProjectile(e.x,e.y+e.height/2,this.damage))}}class TripleWeaponComponent extends WeaponComponent{fire(e){for(let t=-1;t<=1;t++)game.enemyProjectiles.push(new EnemyProjectile(e.x,e.y+e.height/2+10*t,this.damage))}}class SniperWeaponComponent extends WeaponComponent{fire(e){const t=game.player;game.enemyProjectiles.push(new EnemyProjectileAngular(e.x,e.y+e.height/2,t.x+t.width/2,t.y+t.height/2,this.damage))}}class DiveWeaponComponent extends WeaponComponent{constructor(e={}){super(e),this.hasFired=!1}fire(e){if(!this.hasFired&&"diving"===e.phase){const t=game.player;game.enemyProjectiles.push(new EnemyProjectileAngular(e.x,e.y+e.height/2,t.x+t.width/2,t.y+t.height/2,this.damage)),this.hasFired=!0}}}class SmokeParticle{constructor(e,t){this.x=e,this.y=t,this.vx=.5*(Math.random()-.5),this.vy=2*-Math.random()-1,this.size=2*Math.random()+4,this.life=30,this.maxLife=this.life,this.opacity=.6}update(){this.x+=this.vx,this.y+=this.vy,this.life--,this.size+=.3,this.opacity=this.life/this.maxLife*.8,this.vy*=.98}draw(e){if(!e)return;const t=this.opacity;e.fillStyle=`rgba(40, 40, 40, ${t})`,e.beginPath(),e.arc(this.x,this.y,this.size,0,2*Math.PI),e.fill(),e.fillStyle=`rgba(80, 80, 80, ${.5*t})`,e.beginPath(),e.arc(this.x-.2*this.size,this.y-.2*this.size,.6*this.size,0,2*Math.PI),e.fill()}get dead(){return this.life<=0}}class ImpactParticle{constructor(e,t){this.x=e,this.y=t;const i=Math.random()*Math.PI*2,s=3*Math.random()+2;this.vx=Math.cos(i)*s,this.vy=Math.sin(i)*s,this.size=3*Math.random()+2,this.life=20,this.maxLife=this.life;const a=["#ff0000","#ff4400","#ff8800","#ffaa00","#ffff00"];this.color=a[Math.floor(Math.random()*a.length)]}update(){this.x+=this.vx,this.y+=this.vy,this.vx*=.95,this.vy*=.95,this.life--,this.size*=.95}draw(e){if(!e)return;const t=this.life/this.maxLife;e.fillStyle=this.color,e.globalAlpha=t,e.beginPath(),e.arc(this.x,this.y,this.size,0,2*Math.PI),e.fill(),e.globalAlpha=1}get dead(){return this.life<=0}}class FlameParticle{constructor(e,t){this.x=e,this.y=t,this.vx=2*Math.random()+1,this.vy=1*(Math.random()-.5),this.size=1*Math.random()+2,this.life=15,this.maxLife=this.life;const i=["#FF4500","#FF6347","#FF8C00","#FFD700","#FFA500","#FF0000"];this.color=i[Math.floor(Math.random()*i.length)]}update(){this.x+=this.vx,this.y+=this.vy,this.life--,this.size*=.95}draw(){const e=this.life/this.maxLife;ctx.save(),ctx.globalAlpha=e,ctx.fillStyle=this.color,ctx.beginPath(),ctx.arc(this.x,this.y,this.size,0,2*Math.PI),ctx.fill(),ctx.restore()}get dead(){return this.life<=0}}class Enemy{constructor(e,t){this.x=e,this.y=t,this.width=50,this.height=50,this.speed=2,this.cooldown=180*Math.random()+60,this.damage=1,this.flameParticles=[],this.flameSpawnCounter=0,this.wobbleOffset=Math.random()*Math.PI*2,this.wobbleSpeed=.06,this.wobbleAmplitude=15,this.baseY=t,this.wobbleCounter=0}draw(){this.flameParticles.forEach((e=>e.draw())),IMAGES.inimigo1&&IMAGES.inimigo1.complete?ctx.drawImage(IMAGES.inimigo1,this.x,this.y,this.width,this.height):(ctx.fillStyle="#594700",ctx.fillRect(this.x,this.y,this.width,this.height))}update(){if(this.x-=this.speed,this.wobbleCounter+=this.wobbleSpeed,this.y=this.baseY+Math.sin(this.wobbleCounter+this.wobbleOffset)*this.wobbleAmplitude,this.cooldown--,this.cooldown<=0&&(game.enemyProjectiles.push(new EnemyProjectile(this.x,this.y+this.height/2,this.damage)),this.cooldown=180*Math.random()+60),this.flameSpawnCounter++,this.flameSpawnCounter>=3){this.flameSpawnCounter=0;const e=this.x+this.width,t=this.y+this.height/2,i=Math.floor(2*Math.random())+2;for(let s=0;s<i;s++)this.flameParticles.push(new FlameParticle(e,t+10*(Math.random()-.5)))}this.flameParticles.forEach((e=>e.update())),this.flameParticles=this.flameParticles.filter((e=>!e.dead))}}function createEnemy(e,t,i="basic"){const s={basic:{sprite:"inimigo1",width:50,height:50,health:2,movement:{speed:2,wobbleSpeed:.06,wobbleAmplitude:15},flames:{spawnRate:3,particleCount:[2,3]},weapon:{damage:1,cooldownMin:60,cooldownMax:180}},drone:{sprite:"inimigo2",width:45,height:45,health:4,movement:{speed:2.5,wobbleSpeed:.08,wobbleAmplitude:10},flames:{spawnRate:4,particleCount:[1,2]},weapon:{damage:1,cooldownMin:60,cooldownMax:180}},bomber:{sprite:"inimigo3",width:40,height:40,health:3,movement:{speed:2,wobbleSpeed:.05,wobbleAmplitude:12},flames:{spawnRate:3,particleCount:[2,3]},weaponType:"triple",weapon:{damage:1,cooldownMin:90,cooldownMax:150}},sniper:{sprite:"inimigo4",width:20,height:60,health:4,movement:{speed:1,wobbleSpeed:.03,wobbleAmplitude:8},flames:{spawnRate:5,particleCount:[1,2]},weaponType:"sniper",weapon:{damage:2,cooldownMin:180,cooldownMax:240}},shielded:{sprite:"inimigo4",width:50,height:50,health:10,movement:{speed:1.5,wobbleSpeed:.04,wobbleAmplitude:10},flames:{spawnRate:4,particleCount:[2,3]},weapon:{damage:2,cooldownMin:70,cooldownMax:130}}},a=s[i]||s.basic,h=new EnemyComposed(e,t,a);return"triple"===a.weaponType?(h.components=h.components.filter((e=>!(e instanceof WeaponComponent))),h.components.push(new TripleWeaponComponent(a.weapon))):"sniper"===a.weaponType&&(h.components=h.components.filter((e=>!(e instanceof WeaponComponent))),h.components.push(new SniperWeaponComponent(a.weapon))),h}class EnemyComposed{constructor(e,t,i={}){this.x=e,this.y=t,this.baseY=t,this.width=i.width||50,this.height=i.height||50,this.sprite=i.sprite||"inimigo1",this.damage=i.damage||1,this.maxHealth=i.health||1,this.health=this.maxHealth,this.components=[],!1!==i.movement&&this.components.push(new WobbleMovement(i.movement||{speed:2,wobbleSpeed:.06,wobbleAmplitude:15})),!1!==i.flames&&this.components.push(new FlameEmitter(i.flames||{spawnRate:3,particleCount:[2,3],offsetX:0,offsetY:0})),!1!==i.weapon&&this.components.push(new WeaponComponent(i.weapon||{damage:this.damage,cooldownMin:60,cooldownMax:180}))}takeDamage(e=1){return this.health-=e,this.health<=0}addComponent(e){return this.components.push(e),this}update(){this.components.forEach((e=>{e.update&&e.update(this)}))}draw(){this.components.forEach((e=>{e.draw&&e.draw(this)})),IMAGES[this.sprite]&&IMAGES[this.sprite].complete?ctx.drawImage(IMAGES[this.sprite],this.x,this.y,this.width,this.height):(ctx.fillStyle="#594700",ctx.fillRect(this.x,this.y,this.width,this.height)),ctx.fillStyle="gray",ctx.fillRect(this.x,this.y-6,this.width,5),ctx.fillStyle="lime",ctx.fillRect(this.x,this.y-6,this.width*(this.health/this.maxHealth),5),ctx.strokeStyle="black",ctx.strokeRect(this.x,this.y-6,this.width,5)}}class MiniBoss extends Enemy{constructor(e,t){super(e,t),this.width=120,this.height=80,this.maxHealth=50,this.health=50,this.speed=1,this.cooldown=90}update(){const e=game.player;void 0===this.dodgeCooldown&&(this.dodgeCooldown=0),void 0===this.evadeDirection&&(this.evadeDirection=0);if(e.x>this.x+30?this.x+=1.5:this.x>405?this.x-=1:this.x<395&&(this.x+=1),this.dodgeCooldown<=0)for(let e of game.projectiles){const t=e.x>this.x-100&&e.x<this.x+this.width,i=e.y>this.y-30&&e.y<this.y+this.height+30;if(t&&i){this.evadeDirection=e.y<this.y?1:-1,this.dodgeCooldown=30;break}}else this.dodgeCooldown--;if(this.y+=3*this.evadeDirection,this.evadeDirection*=.9,Math.abs(this.evadeDirection)<.1){const t=.02*(e.y-this.y);this.y+=t}if(this.cooldown--,this.cooldown<=0){for(let e=-1;e<=1;e++){const t=.2*e,i=5,s=Math.cos(t)*-i,a=Math.sin(t)*i;game.enemyProjectiles.push(new MiniBossProjectile(this.x,this.y+this.height/2,s,a))}this.cooldown=90}}draw(){ctx.fillStyle="#880000",ctx.fillRect(this.x,this.y,this.width,this.height),ctx.fillStyle="black",ctx.fillRect(this.x,this.y-10,this.width,6),ctx.fillStyle="red",ctx.fillRect(this.x,this.y-10,this.width*(this.health/this.maxHealth),6)}takeDamage(e){if(this.health-=e,this.health<=0){this.dead=!0,game.damageTexts.push(new DamageText(this.x,this.y,"Boss Defeated!","red"));for(let e=0;e<10&&game.coinsDropped.length<50;e++){const e=80*(Math.random()-.5),t=80*(Math.random()-.5);game.coinsDropped.push(new CoinDrop(this.x+e,this.y+t,5))}return game.powerUps.push(new PowerUp(this.x-30,this.y)),game.powerUps.push(new PowerUp(this.x+30,this.y)),!0}return!1}}class MiniBossProjectile{constructor(e,t,i,s){this.x=e,this.y=t,this.vx=i,this.vy=s,this.width=10,this.height=4,this.damage=2}update(){this.x+=this.vx,this.y+=this.vy}draw(){ctx.fillStyle="darkred",ctx.fillRect(this.x,this.y,this.width,this.height)}}class TankSmokeParticle{constructor(e,t){this.x=e,this.y=t,this.vx=.5*Math.random()-.5,this.vy=.5*-Math.random()-.3,this.size=3*Math.random()+2,this.life=40,this.maxLife=this.life,this.opacity=.5}update(){this.x+=this.vx,this.y+=this.vy,this.life--,this.size+=.15,this.opacity=this.life/this.maxLife*.5,this.vy*=.98}draw(){const e=this.opacity;ctx.fillStyle=`rgba(60, 60, 60, ${e})`,ctx.beginPath(),ctx.arc(this.x,this.y,this.size,0,2*Math.PI),ctx.fill(),ctx.fillStyle=`rgba(100, 100, 100, ${.3*e})`,ctx.beginPath(),ctx.arc(this.x-.3*this.size,this.y-.3*this.size,.5*this.size,0,2*Math.PI),ctx.fill()}get dead(){return this.life<=0}}class MuzzleFlashParticle{constructor(e,t,i){this.x=e,this.y=t;const s=.3*(Math.random()-.5);this.vx=Math.cos(i+s)*(2*Math.random()+1),this.vy=Math.sin(i+s)*(2*Math.random()+1),this.size=2*Math.random()+2,this.life=15,this.maxLife=this.life,this.opacity=1;const a=["#ffff00","#ffaa00","#ff8800","#ffffff","#ffcc00"];this.color=a[Math.floor(Math.random()*a.length)]}update(){this.x+=this.vx,this.y+=this.vy,this.life--,this.size+=.2,this.opacity=this.life/this.maxLife,this.vx*=.92,this.vy*=.92}draw(){ctx.save(),ctx.globalAlpha=this.opacity,ctx.fillStyle=this.color,ctx.beginPath(),ctx.arc(this.x,this.y,this.size,0,2*Math.PI),ctx.fill(),ctx.shadowBlur=8,ctx.shadowColor=this.color,ctx.fillStyle=this.color,ctx.beginPath(),ctx.arc(this.x,this.y,.5*this.size,0,2*Math.PI),ctx.fill(),ctx.restore()}get dead(){return this.life<=0}}class Tank{constructor(e){this.x=e,this.y=canvas.height-.1*canvas.height-40,this.width=80,this.height=60,this.speed=1.2,this.cooldown=180*Math.random()+60,this.cannonAngle=0,this.cannonLength=45,this.wheelRotation=0,this.wheelRadius=9,this.wheelPositions=[{x:15,y:this.height-11},{x:35,y:this.height-11},{x:55,y:this.height-11}],this.smokeParticles=[],this.smokeSpawnCounter=0}drawWheel(e,t){ctx.save(),ctx.translate(e,t),ctx.rotate(this.wheelRotation),ctx.fillStyle="#2a2a2a",ctx.beginPath(),ctx.arc(0,0,this.wheelRadius,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#555",ctx.beginPath(),ctx.arc(0,0,this.wheelRadius-2,0,2*Math.PI),ctx.fill(),ctx.strokeStyle="#777",ctx.lineWidth=1.5;for(let e=0;e<4;e++){const t=e*Math.PI/2;ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(Math.cos(t)*(this.wheelRadius-2),Math.sin(t)*(this.wheelRadius-2)),ctx.stroke()}ctx.restore()}draw(){this.smokeParticles.forEach((e=>e.draw())),IMAGES.tank&&IMAGES.tank.complete?ctx.drawImage(IMAGES.tank,this.x,this.y,this.width,this.height):(ctx.fillStyle="#333",ctx.fillRect(this.x,this.y,this.width,this.height)),this.wheelPositions.forEach((e=>{this.drawWheel(this.x+e.x,this.y+e.y)}));const e=this.x+this.width/2,t=this.y+15;ctx.save(),ctx.translate(e,t),ctx.rotate(this.cannonAngle),ctx.fillStyle="#3e541f",ctx.fillRect(0,-3,this.cannonLength,6),ctx.fillStyle="#222",ctx.fillRect(this.cannonLength-5,-4,5,8),ctx.restore()}update(){if(this.x-=this.speed,this.wheelRotation+=.15*this.speed,this.smokeSpawnCounter++,this.smokeSpawnCounter>=8){const e=this.x+this.width-5,t=this.y+this.height/2;this.smokeParticles.push(new TankSmokeParticle(e,t)),this.smokeSpawnCounter=0}this.smokeParticles.forEach((e=>e.update())),this.smokeParticles=this.smokeParticles.filter((e=>!e.dead));const e=game.player,t=e.x+e.width/2-(this.x+this.width/2),i=e.y+e.height/2-(this.y+this.height/2-5);if(this.cannonAngle=Math.atan2(i,t),this.cooldown--,this.cooldown<=0){const t=this.x+this.width/2,i=this.y+this.height/2-5,s=t+Math.cos(this.cannonAngle)*this.cannonLength,a=i+Math.sin(this.cannonAngle)*this.cannonLength;game.enemyProjectiles.push(new EnemyProjectileAngular(s,a,e.x+e.width/2,e.y+e.height/2));const h=Math.floor(3*Math.random())+6;for(let e=0;e<h;e++)this.smokeParticles.push(new MuzzleFlashParticle(s-5,a-5,this.cannonAngle));this.cooldown=180*Math.random()+60}}}class DiveEnemy{constructor(e){const t=game.player;this.x=e,this.y=t.y,this.width=30,this.height=30,this.speed=5,this.phase="approaching",this.attackSpeed=6,this.exitSpeed=4,this.triggerDistance=250,this.shot=!1}update(){const e=game.player;if("approaching"===this.phase){this.x-=this.speed;this.x-(e.x+e.width)<this.triggerDistance&&(this.phase="diving")}else"diving"===this.phase?(this.y+=this.attackSpeed,this.x-=.5*this.speed,!this.shot&&Math.abs(this.y-e.y)<30&&(game.enemyProjectiles.push(new EnemyProjectile(this.x,this.y+this.height/2)),this.shot=!0),this.y>e.y+50&&(this.phase="exiting")):"exiting"===this.phase&&(this.y-=this.exitSpeed,this.x-=.5*this.speed)}draw(){ctx.fillStyle="#ffaa00",ctx.fillRect(this.x,this.y,this.width,this.height)}}function dropOnEnemyDeath(e){const t=Math.random();if(t<.1)game.powerUps.push(new PowerUp(e.x,e.y));else if(t<.2){const t=[...Object.values(WeaponTypes),...Object.values(AuxiliaryWeaponTypes)],i=t[Math.floor(Math.random()*t.length)];game.powerUps.push(new WeaponPowerUp(e.x,e.y,i))}}function spawnDroneFormation(e=3){const t=canvas.width+50,i=50+Math.random()*(canvas.height-200),s=[];for(let a=0;a<e;a++){const e=30*a;s.push(createEnemy(t+30*a,i+e,"drone"))}return s}function spawnArrowFormationGeneric(e,t=6,i="<",s=30,a=20){const h=[],o=canvas.width+50,n=.1*canvas.height,l=(t-1)*a,r=60+l/2,c=canvas.height-n-l/2,d=r+Math.random()*(c-r),m=Math.floor(t/2);for(let n=0;n<t;n++){const t=Math.abs(n-m);let l,r;switch(i){case"<":l=o+n*s,r=d+t*a;break;case">":l=o-n*s,r=d+t*a;break;case"V":l=o+t*s,r=d+n*a;break;case"^":l=o+t*s,r=d-n*a}e===Enemy||"Enemy"===e||"basic"===e?h.push(createEnemy(l,r,"basic")):"DroneEnemy"===e||"drone"===e?h.push(createEnemy(l,r,"drone")):"BomberEnemy"===e||"bomber"===e?h.push(createEnemy(l,r,"bomber")):"SniperEnemy"===e||"sniper"===e?h.push(createEnemy(l,r,"sniper")):"ShieldedEnemy"===e||"shielded"===e?h.push(createEnemy(l,r,"shielded")):h.push(new e(l,r))}return h}class DamageText{constructor(e,t,i,s="yellow"){this.x=e,this.y=t,this.text=i,this.color=s,this.alpha=1,this.lifetime=60}draw(){ctx.globalAlpha=this.alpha,ctx.fillStyle=this.color,ctx.font="16px Arial",ctx.fillText(this.text,this.x,this.y),ctx.globalAlpha=1}update(){this.y-=.5,this.alpha-=1/this.lifetime}isAlive(){return this.alpha>0}}function addHealthToEnemy(e,t=1){return class extends e{constructor(...e){super(...e),this.maxHealth=t,this.health=t}draw(){super.draw(),ctx.fillStyle="gray",ctx.fillRect(this.x,this.y-6,this.width,5),ctx.fillStyle="lime",ctx.fillRect(this.x,this.y-6,this.width*(this.health/this.maxHealth),5),ctx.strokeStyle="black",ctx.strokeRect(this.x,this.y-6,this.width,5)}takeDamage(e=1){return this.health-=e,this.health<=0}}}Enemy=addHealthToEnemy(Enemy,1),DiveEnemy=addHealthToEnemy(DiveEnemy,2),Tank=addHealthToEnemy(Tank,5);const WaveConfig={waves:{1:{enemies:5,tanks:0,boss:!1},2:{enemies:6,tanks:0,boss:!1},3:{enemies:7,tanks:1,boss:!1},4:{enemies:8,tanks:1,boss:!1},5:{enemies:10,tanks:2,boss:!0},6:{enemies:9,tanks:2,boss:!1},7:{enemies:10,tanks:2,boss:!1},8:{enemies:12,tanks:3,boss:!1},9:{enemies:13,tanks:3,boss:!1},10:{enemies:15,tanks:3,boss:!0},11:{enemies:14,tanks:4,boss:!1},12:{enemies:15,tanks:4,boss:!1},13:{enemies:16,tanks:4,boss:!1},14:{enemies:17,tanks:5,boss:!1},15:{enemies:20,tanks:5,boss:!0},16:{enemies:18,tanks:5,boss:!1},17:{enemies:19,tanks:6,boss:!1},18:{enemies:20,tanks:6,boss:!1},19:{enemies:22,tanks:7,boss:!1},20:{enemies:25,tanks:8,boss:!0}},getWaveConfig(e){if(this.waves[e])return this.waves[e];return{enemies:Math.min(20+Math.floor(1.5*(e-20)),40),tanks:Math.min(5+Math.floor((e-20)/2),15),boss:e%5==0}},getCoinReward(e){return 10+5*e+(this.getWaveConfig(e).boss?50:0)}},WaveSystem={currentWave:0,waveActive:!1,startWave(e){this.currentWave=e,this.waveActive=!0,this.spawnWaveEnemies(e)},spawnWaveEnemies(e){const t=WaveConfig.getWaveConfig(e);let i=0,s=0;for(;i<t.enemies;){const a=t.enemies-i,h=Math.random();setTimeout((()=>{if(h<.3&&a>=5){const e=spawnArrowFormationGeneric(Enemy,Math.min(5,a),"<");if(e){const t=Array.isArray(e)?e:[e];game.enemies.push(...t)}}else if(h<.5&&a>=4&&e>=3){const e=spawnDroneFormation(Math.min(4,a));if(e){const t=Array.isArray(e)?e:[e];game.enemies.push(...t)}}else{const e=canvas.width+50+100*Math.random(),t=50+Math.random()*(.6*canvas.height);game.enemies.push(createEnemy(e,t,"basic"))}}),s),h<.3&&a>=5?i+=5:h<.5&&a>=4&&e>=3?i+=4:i++,s+=1500}for(let e=0;e<t.tanks;e++)setTimeout((()=>{const e=canvas.width+100+200*Math.random();game.tanks.push(new Tank(e))}),2e3*(e+1)+s);t.boss&&setTimeout((()=>{game.enemies.push(new MiniBoss(canvas.width+100,canvas.height/2))}),3e3+s)},checkWaveComplete(){this.waveActive&&0===game.enemies.length&&0===game.tanks.length&&(this.waveActive=!1,this.onWaveComplete())},onWaveComplete(){const e=WaveConfig.getCoinReward(this.currentWave);game.coins+=e,setTimeout((()=>{const e=this.currentWave+1;this.startWave(e)}),100)}},waves=[()=>spawnArrowFormationGeneric(Enemy,5),()=>spawnDroneFormation(6),()=>game.enemies.push(new MiniBoss(canvas.width+100,200)),()=>spawnArrowFormationGeneric(SniperEnemy,7),()=>{spawnArrowFormationGeneric(Enemy,3),spawnArrowFormationGeneric(DroneEnemy,6)},()=>game.enemies.push(new MiniBoss(canvas.width+100,250))];let currentWave=0,waveCountdown=180,showingWaveText=!1,waveTextTimer=60;function novoInimigoAleatorio(){const e=Math.random(),t=canvas.width+400*Math.random(),i=.1*canvas.height,s=canvas.height-i-50,a=Math.random()*s;return e<.2?[createEnemy(t,a,"bomber")]:e<.4?spawnArrowFormationGeneric("sniper",Math.floor(1*Math.random())+3,">"):e<.6?spawnArrowFormationGeneric("shielded",Math.floor(3*Math.random())+3,"<"):e<.8?spawnArrowFormationGeneric(DiveEnemy,Math.floor(3*Math.random())+3,"^"):e<.95?spawnArrowFormationGeneric(DroneEnemy,Math.floor(12*Math.random())+12,"^"):null}function isOverlapping(e,t,i=75){return e.x<t.x+t.width+i&&e.x+e.width+i>t.x&&e.y<t.y+t.height+i&&e.y+e.height+i>t.y}function spawnWithDistance(e,t,i=15){let s=0;for(;s<i;){const i=e();if(!i)return null;const a=Array.isArray(i)?i:[i];if(!a.some((e=>t.some((t=>isOverlapping(e,t))))))return a;s++}return e()}const game=window.game={debug:!1,devMode:!1,player:new Player,projectiles:[],enemyProjectiles:[],enemies:[],tanks:[],powerUps:[],coinsDropped:[],grassXs:[],parallaxLayers:[],comboSystem:new ComboSystem,countdownSystem:new CountdownSystem,score:0,coins:0,lives:3,highScore:0,highWave:0,upgrades:{damage:0,speed:0,maxHealth:0,fireRate:0,regen:!1},fps:60,lastFrameTime:0,gameOver:!1,gameOverEventSent:!1,isPaused:!1,damageTexts:[],regenTimer:0,miniBoss:null,bossTimer:2500,bossActive:!1,particles:[],init(){const e=SaveSystem.load();this.reset(),e&&SaveSystem.applyLoad(e),this.isPaused=!0,this.countdownSystem.start((()=>{this.isPaused=!1,WaveSystem.startWave(1)}),""),this.loop(0)},handleGameOver(){this.gameOver=!0,this.lives--,this.score>this.highScore&&(this.highScore=this.score),WaveSystem.currentWave>this.highWave&&(this.highWave=WaveSystem.currentWave),this.lives<=0?(SaveSystem.clear(),setTimeout((()=>{this.lives=3,this.coins=0,this.highScore=0,this.highWave=0,this.reset(),this.gameOver=!1}),3e3)):(SaveSystem.save(),setTimeout((()=>{this.reset(),this.gameOver=!1,WaveSystem.startWave(1)}),2e3))},reset(){this.player=new Player,this.projectiles=[],this.enemyProjectiles=[],this.powerUps=[],this.coinsDropped=[],this.enemies=[],this.tanks=[],this.parallaxLayers=[new ParallaxLayer(IMAGES.parallax1,.2,0),new ParallaxLayer(IMAGES.parallax2,.4,0),new ParallaxLayer(IMAGES.parallax3,.6,0),new ParallaxLayer(IMAGES.parallax4,.8,0),new ParallaxLayer(IMAGES.parallax5,1,0),new ParallaxLayer(IMAGES.parallax6,1.5,0)],this.parallaxLayers.forEach((e=>e.updateSpeed(controlMode)));for(let e=0;e<3;e++){const t=spawnWithDistance((()=>new Tank(canvas.width+400*e)),[...this.enemies,...this.tanks]);if(t){const e=Array.isArray(t)?t:[t];this.tanks.push(...e)}}this.grassXs=Array.from({length:Math.ceil(canvas.width/20)+2},((e,t)=>20*t)),this.score=0,this.gameOver=!1,this.gameOverEventSent=!1,this.damageTexts=[],this.comboSystem.reset()},update(){if(!this.gameOver&&!this.player.isDying){WaveSystem.checkWaveComplete(),this.player.update(),game.player.targetX=null,game.player.targetY=null,game.upgrades.regen&&this.player.health<this.player.maxHealth?(this.regenTimer++,this.regenTimer>=600&&(this.player.health=Math.min(this.player.maxHealth,this.player.health+1),this.regenTimer=0,game.damageTexts.push(new DamageText(this.player.x,this.player.y-20,"+1 HP","#00ff00")))):this.regenTimer=0,this.comboSystem.update(),this.damageTexts.forEach((e=>e.update())),this.damageTexts=this.damageTexts.filter((e=>e.isAlive())),game.projectiles=game.projectiles.filter((e=>!e.dead)),game.particles=game.particles.filter((e=>!e.dead)),game.particles.forEach((e=>e.update())),this.projectiles.forEach((e=>e.update())),this.projectiles=this.projectiles.filter((e=>!e.dead)),this.projectiles=this.projectiles.filter((e=>e.x<canvas.width&&e.y+e.height>0&&e.y<canvas.height)),this.enemyProjectiles.forEach((e=>e.update())),this.enemyProjectiles=this.enemyProjectiles.filter((e=>e.x+e.width>0&&e.y+e.height>0&&e.y<canvas.height)),this.enemies.forEach((e=>e.update())),this.enemies=this.enemies.filter((e=>e.x+e.width>0&&e.y+e.height>0&&e.y<canvas.height)),this.tanks.forEach((e=>e.update())),this.tanks=this.tanks.filter((e=>e.x+e.width>0)),this.powerUps.forEach((e=>e.update())),this.powerUps=this.powerUps.filter((e=>!e.dead)),this.coinsDropped.forEach((e=>{e.update();const t=e.x+e.width/2-(this.player.x+this.player.width/2),i=e.y+e.height/2-(this.player.y+this.player.height/2);if(Math.sqrt(t*t+i*i)<30){e.collected=!0,this.coins+=e.value,this.damageTexts.push(new DamageText(e.x,e.y-10,`+${e.value}â­`,"#FFD700"));for(let t=0;t<5;t++)this.particles.push(new ExplosionParticle(e.x+e.width/2,e.y+e.height/2,"#FFD700"))}})),this.coinsDropped=this.coinsDropped.filter((e=>!e.dead)),this.projectiles.forEach(((e,t)=>{this.enemies.forEach(((i,s)=>{if(e.x<i.x+i.width&&e.x+e.width>i.x&&e.y<i.y+i.height&&e.y+e.height>i.y){if(HitEffectManager.spawnEffect(e.x,e.y,i.hitEffect),i.takeDamage&&i.takeDamage(e.damage)){createExplosion(i.x+i.width/2,i.y+i.height/2,.8,15),this.enemies.splice(s,1),this.comboSystem.addKill();const e=Math.floor(1*this.comboSystem.multiplier);this.score+=e,Math.random()<.3&&this.coinsDropped.length<50&&this.coinsDropped.push(new CoinDrop(i.x,i.y,1)),Math.random()<.1&&this.powerUps.push(new PowerUp(i.x,i.y)),e>1&&this.damageTexts.push(new DamageText(i.x,i.y-20,`+${e}`,"yellow"))}this.projectiles.splice(t,1),this.damageTexts.push(new DamageText(i.x,i.y,"-"+e.damage.toFixed(2),"orange"))}})),this.tanks.forEach(((i,s)=>{if(e.x<i.x+i.width&&e.x+e.width>i.x&&e.y<i.y+i.height&&e.y+e.height>i.y){for(let e=0;e<6;e++)HitEffectManager.spawnEffect(i.x,i.y,i.hitEffect);if(i.takeDamage&&i.takeDamage(e.damage)){createExplosion(i.x+i.width/2,i.y+i.height/2,1.5,30),this.tanks.splice(s,1),this.comboSystem.addKill();const e=Math.floor(2*this.comboSystem.multiplier);this.score+=e;const t=Math.floor(4*Math.random())+2;for(let e=0;e<t&&this.coinsDropped.length<50;e++){const e=40*(Math.random()-.5),t=40*(Math.random()-.5);this.coinsDropped.push(new CoinDrop(i.x+e,i.y+t,2))}Math.random()<.25&&this.powerUps.push(new PowerUp(i.x,i.y)),e>2&&this.damageTexts.push(new DamageText(i.x,i.y-20,`+${e}`,"yellow"))}this.projectiles.splice(t,1),this.damageTexts.push(new DamageText(i.x,i.y,"-"+e.damage.toFixed(2),"orange"))}}))}));for(let e of this.enemyProjectiles){if(e.x<this.player.x+this.player.width&&e.x+e.width>this.player.x&&e.y<this.player.y+this.player.height&&e.y+e.height>this.player.y&&!this.player.invincible)return this.player.shieldActive&&this.player.shieldTimer>0?(this.player.shieldTimer=0,this.player.shieldActive=!1,this.damageTexts.push(new DamageText(this.player.x,this.player.y,"SHIELD!","cyan"))):this.player.takeDamage(e.damage,e.x,e.y),void(this.enemyProjectiles=this.enemyProjectiles.filter((t=>t!==e)))}[...this.enemies,...this.tanks,...this.miniBoss?[this.miniBoss]:[]].forEach((e=>{!(this.player.x<e.x+e.width&&this.player.x+this.player.width>e.x&&this.player.y<e.y+e.height&&this.player.y+this.player.height>e.y)||this.player.invincible||(this.player.shieldActive&&this.player.shieldTimer>0?(this.player.shieldTimer=0,this.player.shieldActive=!1,this.damageTexts.push(new DamageText(this.player.x,this.player.y,"SHIELD!","cyan"))):this.player.takeDamage(1,e.x+e.width/2,e.y+e.height/2))}));for(let e of this.powerUps){this.player.x<e.x+e.width&&this.player.x+this.player.width>e.x&&this.player.y<e.y+e.height&&this.player.y+this.player.height>e.y&&(this.powerUps=this.powerUps.filter((t=>t!==e)),e instanceof WeaponPowerUp?(e.apply(this.player),this.damageTexts.push(new DamageText(e.x,e.y,e.weaponType.name,"blue"))):e instanceof DropInstance?e.apply(this.player):e instanceof PowerUp&&this.player.health<this.player.maxHealth&&(this.player.health++,this.damageTexts.push(new DamageText(e.x,e.y,"+1","green"))))}!this.miniBoss&&this.score>=25&&this.bossTimer<=0?(this.miniBoss=new MiniBoss(canvas.width+50,canvas.height/2-40),this.enemies=[],this.bossActive=!0):this.miniBoss||this.bossTimer--,this.miniBoss&&(this.miniBoss.update(),this.miniBoss?.dead&&(this.miniBoss=null,this.bossTimer=2500,this.bossActive=!1)),this.miniBoss&&this.projectiles.forEach(((e,t)=>{const i=this.miniBoss;e.x<i.x+i.width&&e.x+e.width>i.x&&e.y<i.y+i.height&&e.y+e.height>i.y&&(HitEffectManager.spawnEffect(e.x,e.y,i.hitEffect,1.5),i.takeDamage(e.damage),this.projectiles.splice(t,1),this.damageTexts.push(new DamageText(i.x,i.y,"-"+e.damage.toFixed(2),"orange")))})),(this.player.airborne||controlMode===CONTROLSMODES.PLANE)&&(this.parallaxLayers.forEach((e=>e.update())),this.grassXs=this.grassXs.map((e=>((e-=1)<-20&&(e=canvas.width),e))))}},draw(){ctx.clearRect(0,0,canvas.width,canvas.height),this.drawBackground(),this.player.isDying?this.player.drawDeath():this.player.draw(),this.projectiles.forEach((e=>e.draw())),this.enemyProjectiles.forEach((e=>e.draw())),this.enemies.forEach((e=>e.draw())),this.tanks.forEach((e=>e.draw())),this.powerUps.forEach((e=>e.draw())),this.coinsDropped.forEach((e=>e.draw(ctx))),this.damageTexts.forEach((e=>e.draw())),ctx.fillStyle="black",ctx.font="12px Arial",ctx.fillText("Score: "+this.score,20,30),ctx.fillStyle="#FF4444",ctx.font="bold 16px Arial",ctx.fillText("WAVE: "+WaveSystem.currentWave,20,50),ctx.fillStyle="#FF1744",ctx.font="bold 14px Arial",ctx.fillText("â¤ï¸ x "+this.lives,20,70),ctx.fillStyle="black",ctx.font="12px Arial",ctx.fillText("Weapon: "+this.player.primaryWeapon.name+" (Lv"+this.player.primaryWeapon.level+")",20,90);const e=this.player.auxiliaryWeapons?.map((e=>`${e.name} (Lv${e.level||1})`)).join(", ");e&&(ctx.font="12px Arial",ctx.fillText("Aux: "+e,20,110));const t=canvas.width/2;if(ctx.fillStyle="rgba(0, 0, 0, 0.6)",ctx.strokeStyle="#FFD700",ctx.lineWidth=2,ctx.beginPath(),ctx.roundRect(t-10,15,110,30,15),ctx.fill(),ctx.stroke(),ctx.fillStyle="#FFD700",ctx.beginPath(),ctx.arc(t+10,30,10,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#000",ctx.font="bold 16px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("â­",t+10,30),ctx.fillStyle="#FFD700",ctx.font="bold 20px Arial",ctx.textAlign="left",ctx.textBaseline="middle",ctx.fillText(this.coins,t+30,30),this.debug&&(ctx.fillStyle="black",ctx.font="14px Arial",ctx.fillText("Enemies: "+this.enemies.length,canvas.width-150,30),ctx.fillText("Projectiles: "+this.projectiles.length,canvas.width-150,50),ctx.fillText("FPS: "+this.fps,canvas.width-150,70),ctx.fillText("Damage: "+this.player.primaryWeapon.damage,canvas.width-150,90),ctx.fillText("Cooldown: "+this.player.primaryWeapon.cooldown,canvas.width-150,110)),this.comboSystem.draw(ctx),this.countdownSystem.draw(ctx),this.isPaused&&!this.gameOver&&!this.countdownSystem.active){ctx.fillStyle="rgba(0, 0, 0, 0.3)",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="white",ctx.strokeStyle="black",ctx.lineWidth=4,ctx.font="bold 48px Arial",ctx.textAlign="center",ctx.textBaseline="middle";const e="â¸ï¸ PAUSADO";ctx.strokeText(e,canvas.width/2,canvas.height/2),ctx.fillText(e,canvas.width/2,canvas.height/2)}showingWaveText&&(ctx.fillStyle="white",ctx.font="28px monospace",ctx.textAlign="center",ctx.fillText(`Wave ${currentWave}`,canvas.width/2,80),waveTextTimer--,waveTextTimer<=0&&(showingWaveText=!1)),this.miniBoss&&this.miniBoss.draw(),game.particles.forEach((e=>e.draw(ctx))),this.player.airborne||this.gameOver||(ctx.font="16px Arial",ctx.fillText("Pressione espaÃ§o para voar",20,80)),this.gameOver&&(ctx.fillStyle="red",ctx.font="20px Arial",this.gameOverEventSent||(window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:"game_over",event_category:"game",event_label:"helicopter_shooter",game_score:this.score}),this.gameOverEventSent=!0),this.lives>0?(ctx.fillText("ðŸ’” VOCÃŠ MORREU! ðŸ’”",canvas.width/2-90,canvas.height/2-20),ctx.font="20px monospace",ctx.fillText(`Vidas restantes: ${this.lives}`,canvas.width/2-100,canvas.height/2+20)):(ctx.fillText("ðŸ’¥ GAME OVER ðŸ’¥",canvas.width/2-85,canvas.height/2-20),ctx.font="18px monospace",ctx.fillStyle="#FFD700",ctx.fillText(`High Score: ${this.highScore}`,canvas.width/2-80,canvas.height/2+20),ctx.fillText(`High Wave: ${this.highWave}`,canvas.width/2-70,canvas.height/2+45)))},drawBackground(){this.parallaxLayers.forEach((e=>e.draw(ctx)));const e=canvas.height-.1*canvas.height,t=e-20;ctx.fillStyle="#8b5237",ctx.fillRect(0,e,canvas.width,.1*canvas.height);for(let e of this.grassXs)ctx.drawImage(IMAGES.grass,e,t,18,18)},loop(e){if(e-this.lastFrameTime>=500/this.fps){if(this.countdownSystem.update(),this.player.isDying&&!this.gameOver){this.player.updateDeath()&&this.handleGameOver(),this.player.smokeParticles.forEach((e=>e.update())),this.player.smokeParticles=this.player.smokeParticles.filter((e=>!e.dead)),game.particles=game.particles.filter((e=>!e.dead)),game.particles.forEach((e=>e.update()))}else this.isPaused||this.gameOver||this.update();this.draw(),this.lastFrameTime=e}requestAnimationFrame((e=>this.loop(e)))}},SaveSystem={SAVE_KEY:"helicopterShooterSave",save(){const e={coins:game.coins,lives:game.lives,primaryWeapon:game.player.primaryWeapon.name,auxiliaryWeapons:game.player.auxiliaryWeapons.map((e=>e.name)),highScore:game.highScore||0,highWave:game.highWave||0,upgrades:game.upgrades};localStorage.setItem(this.SAVE_KEY,JSON.stringify(e))},load(){const e=localStorage.getItem(this.SAVE_KEY);if(!e)return null;try{return JSON.parse(e)}catch(e){return console.error("Erro ao carregar save:",e),null}},clear(){localStorage.removeItem(this.SAVE_KEY)},applyLoad(e){if(e){if(game.coins=e.coins||0,game.lives=e.lives||3,game.highScore=e.highScore||0,game.highWave=e.highWave||0,e.upgrades&&(game.upgrades=e.upgrades),this.applyUpgradesToPlayer(),e.primaryWeapon&&"BASIC"!==e.primaryWeapon){const t=ShopSystem.primaryWeapons.find((t=>t.name===e.primaryWeapon));t&&(game.player.primaryWeapon=new WeaponInstance(t.type))}e.auxiliaryWeapons&&e.auxiliaryWeapons.length>0&&(game.player.auxiliaryWeapons=[],e.auxiliaryWeapons.forEach((e=>{const t=ShopSystem.auxiliaryWeapons.find((t=>t.name===e));t&&game.player.auxiliaryWeapons.push(new WeaponInstance(t.type))})))}},applyUpgradesToPlayer(){const e=game.player;e.maxHealth=5+game.upgrades.maxHealth,e.health>e.maxHealth&&(e.health=e.maxHealth);e.speed=8*(1+.15*game.upgrades.speed)}},ShopSystem={isOpen:!1,primaryWeapons:[{id:"basic",name:"BASIC",desc:"Arma inicial - Tiro simples",price:0,type:WeaponTypes.BASIC},{id:"spread",name:"SPREAD",desc:"Dispara 3 projÃ©teis em leque",price:50,type:WeaponTypes.SPREAD},{id:"burst",name:"BURST",desc:"Rajada rÃ¡pida de 3 tiros",price:80,type:WeaponTypes.BURST},{id:"laser",name:"LASER",desc:"Raio laser contÃ­nuo",price:120,type:WeaponTypes.LASER},{id:"missile",name:"MISSILE",desc:"MÃ­sseis teleguiados poderosos",price:150,type:WeaponTypes.MISSILE}],auxiliaryWeapons:[{id:"orbital",name:"ORBITAL",desc:"ðŸ›¸ SatÃ©lites que orbitam e atiram",price:50,type:AuxiliaryWeaponTypes.ORBITAL},{id:"missile",name:"MISSILE",desc:"ðŸš€ MÃ­sseis teleguiados automÃ¡ticos",price:70,type:AuxiliaryWeaponTypes.MISSILE},{id:"turret",name:"TURRET",desc:"ðŸ”« Torreta lateral de fogo rÃ¡pido",price:60,type:AuxiliaryWeaponTypes.TURRET},{id:"beam",name:"BEAM",desc:"âš¡ Raios laterais contÃ­nuos",price:65,type:AuxiliaryWeaponTypes.BEAM},{id:"shield",name:"SHIELD",desc:"ðŸ›¡ï¸ Escudo absorve 1 hit (3 min)",price:100,type:AuxiliaryWeaponTypes.SHIELD}],init(){const e=document.getElementById("shopButton"),t=document.getElementById("shopModal"),i=document.getElementById("closeShop");e.addEventListener("click",(()=>this.open())),i.addEventListener("click",(()=>this.close())),t.addEventListener("click",(e=>{e.target===t&&this.close()}));const s=document.querySelectorAll(".shopTab"),a=document.querySelectorAll(".shopTabContent");s.forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-tab");s.forEach((e=>e.classList.remove("active"))),a.forEach((e=>e.classList.remove("active"))),e.classList.add("active"),document.getElementById(t+"Tab").classList.add("active")}))})),this.render()},open(){this.isOpen=!0,game.isPaused=!0,document.getElementById("shopModal").classList.add("active"),this.render()},close(){this.isOpen=!1,game.isPaused=!1,document.getElementById("shopModal").classList.remove("active")},render(){document.getElementById("shopCoins").textContent=game.coins;const e=game.player.auxiliaryWeapons.length;document.getElementById("auxSlots").textContent=`${e}/3`,this.renderUpgrades();const t=document.getElementById("primaryWeapons");t.innerHTML="",this.primaryWeapons.forEach((e=>{const i=game.player.primaryWeapon.name===e.name,s=game.coins>=e.price,a=document.createElement("div");a.className="shopItem"+(i?" owned":""),a.innerHTML=`\n              <div class="itemInfo">\n                <div class="itemName">${e.name}</div>\n                <div class="itemDesc">${e.desc}</div>\n              </div>\n              <div class="itemPrice">\n                <span style="color: #FFD700; font-size: 18px; font-weight: bold;">\n                  ${e.price} â­\n                </span>\n                <button class="buyButton" \n                  ${!s||i?"disabled":""}\n                  onclick="ShopSystem.buyPrimary('${e.id}')">\n                  ${i?"EQUIPADA":"COMPRAR"}\n                </button>\n              </div>\n            `,t.appendChild(a)}));const i=document.getElementById("auxiliaryWeapons");i.innerHTML="",this.auxiliaryWeapons.forEach((t=>{const s=game.player.auxiliaryWeapons.some((e=>e.name===t.name)),a=game.coins>=t.price&&e<3,h=document.createElement("div");h.className="shopItem"+(s?" owned":""),h.innerHTML=`\n              <div class="itemInfo">\n                <div class="itemName">${t.name}</div>\n                <div class="itemDesc">${t.desc}</div>\n              </div>\n              <div class="itemPrice">\n                <span style="color: #FFD700; font-size: 18px; font-weight: bold;">\n                  ${t.price} â­\n                </span>\n                <button class="buyButton" \n                  ${!a||s?"disabled":""}\n                  onclick="ShopSystem.buyAuxiliary('${t.id}')">\n                  ${s?"EQUIPADA":e>=3?"SEM SLOT":"COMPRAR"}\n                </button>\n              </div>\n            `,i.appendChild(h)}))},buyPrimary(e){const t=this.primaryWeapons.find((t=>t.id===e));t&&game.coins>=t.price&&(game.coins-=t.price,game.player.primaryWeapon=new WeaponInstance(t.type),SaveSystem.save(),this.showPurchaseEffect("Arma PrimÃ¡ria Adquirida!"),this.render())},buyAuxiliary(e){const t=this.auxiliaryWeapons.find((t=>t.id===e));t&&game.coins>=t.price&&game.player.auxiliaryWeapons.length<3&&(game.coins-=t.price,game.player.auxiliaryWeapons.push(new WeaponInstance(t.type)),SaveSystem.save(),this.showPurchaseEffect("Arma Auxiliar Adquirida!"),this.render())},upgrades:[{id:"damage",name:"ðŸ’¥ DANO",desc:"Aumenta o dano de todas as armas",maxLevel:5,basePrice:40,priceIncrease:30,effect:e=>`+${20*e}% Dano`},{id:"speed",name:"âš¡ VELOCIDADE",desc:"Aumenta a velocidade de movimento",maxLevel:5,basePrice:35,priceIncrease:25,effect:e=>`+${15*e}% Velocidade`},{id:"maxHealth",name:"â¤ï¸ VIDA MÃXIMA",desc:"Aumenta sua vida mÃ¡xima",maxLevel:5,basePrice:50,priceIncrease:40,effect:e=>`+${e} HP (Max: ${5+e})`},{id:"fireRate",name:"ðŸ”¥ TAXA DE TIRO",desc:"Reduz o tempo entre disparos",maxLevel:5,basePrice:45,priceIncrease:35,effect:e=>`-${10*e}% Cooldown`},{id:"regen",name:"ðŸ’š REGENERAÃ‡ÃƒO",desc:"Regenera 1 HP a cada 10 segundos",maxLevel:1,basePrice:150,priceIncrease:0,effect:e=>e?"ATIVO":"INATIVO"}],buyUpgrade(e){const t=this.upgrades.find((t=>t.id===e));if(!t)return;const i=!0===game.upgrades[e]?1:game.upgrades[e]||0;if(i>=t.maxLevel)return;const s=t.basePrice+i*t.priceIncrease;game.coins>=s&&(game.coins-=s,"regen"===e?game.upgrades[e]=!0:game.upgrades[e]++,SaveSystem.applyUpgradesToPlayer(),SaveSystem.save(),this.showPurchaseEffect(`${t.name} Melhorado!`),this.render())},renderUpgrades(){const e=document.getElementById("upgradesList");e.innerHTML="",this.upgrades.forEach((t=>{const i="regen"===t.id?game.upgrades[t.id]?1:0:game.upgrades[t.id]||0,s=i>=t.maxLevel,a=t.basePrice+i*t.priceIncrease,h=game.coins>=a&&!s,o=document.createElement("div");o.className="upgradeItem"+(s?" maxed":""),o.innerHTML=`\n              <div class="upgradeHeader">\n                <div class="upgradeTitle">${t.name}</div>\n                <div class="upgradeLevel">NÃ­vel ${i}/${t.maxLevel}</div>\n              </div>\n              <div class="upgradeDesc">${t.desc}</div>\n              <div class="upgradeEffect">â†’ ${t.effect(i)}</div>\n              <div class="upgradeFooter">\n                <span style="color: #FFD700; font-size: 18px; font-weight: bold;">\n                  ${a} â­\n                </span>\n                <button class="buyButton" \n                  ${h?"":"disabled"}\n                  onclick="ShopSystem.buyUpgrade('${t.id}')">\n                  ${s?"MÃXIMO":"MELHORAR"}\n                </button>\n              </div>\n            `,e.appendChild(o)}))},showPurchaseEffect(e){const t=document.createElement("div");t.textContent="âœ… "+e,t.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);\n            color: white;\n            padding: 20px 40px;\n            border-radius: 15px;\n            font-size: 24px;\n            font-weight: bold;\n            z-index: 3000;\n            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n            animation: purchasePopup 1.5s ease-out forwards;\n          ",document.body.appendChild(t),setTimeout((()=>t.remove()),1500)}},style=document.createElement("style");style.textContent="\n        @keyframes purchasePopup {\n          0% {\n            transform: translate(-50%, -50%) scale(0.5);\n            opacity: 0;\n          }\n          50% {\n            transform: translate(-50%, -50%) scale(1.1);\n            opacity: 1;\n          }\n          100% {\n            transform: translate(-50%, -50%) scale(1) translateY(-30px);\n            opacity: 0;\n          }\n        }\n      ",document.head.appendChild(style);const DevTools={init(){document.getElementById("closeDevPanel").addEventListener("click",(()=>this.toggleDevPanel())),setInterval((()=>{game.devMode&&(document.getElementById("devEnemyCount").textContent=game.enemies.length,document.getElementById("devProjectileCount").textContent=game.projectiles.length,document.getElementById("devWaveCount").textContent=WaveSystem.currentWave)}),100)},toggleDevPanel(){game.devMode=!game.devMode;document.getElementById("devPanel").style.display=game.devMode?"block":"none",console.log("Dev Mode:",game.devMode?"ON":"OFF")},togglePause(){game.isPaused=!game.isPaused,console.log("Game paused:",game.isPaused)},clearEnemies(){game.enemies=[],game.tanks=[],game.miniBoss=null,game.bossActive=!1,game.enemyProjectiles=[],console.log("All enemies cleared")},addCoins(e){game.coins+=e,console.log("Added",e,"coins. Total:",game.coins)},forceDeath(){game.player.die(),console.log("ðŸ’€ ForÃ§ando animaÃ§Ã£o de morte do player...")},spawnEnemy(e){const t=canvas.width-50,i=canvas.height/2;let s;switch(e){case"Enemy":s=createEnemy(t,i,"basic"),game.enemies.push(s);break;case"DroneEnemy":s=createEnemy(t,i,"drone"),game.enemies.push(s);break;case"BomberEnemy":s=createEnemy(t,i,"bomber"),game.enemies.push(s);break;case"SniperEnemy":s=createEnemy(t,i,"sniper"),game.enemies.push(s);break;case"DiveEnemy":s=new DiveEnemy(t,i),game.enemies.push(s);break;case"ShieldedEnemy":s=createEnemy(t,i,"shielded"),game.enemies.push(s);break;case"MiniBoss":s=new MiniBoss(t,i),game.enemies.push(s);break;case"Tank":s=new Tank(t,i),game.tanks.push(s)}console.log("Spawned:",e)},spawnFormation(e){"arrow"===e?(WaveSystem.spawnArrowFormationGeneric(DroneEnemy,5),console.log("Spawned arrow formation")):"drone"===e&&(WaveSystem.spawnDroneFormation(5),console.log("Spawned drone formation"))}};document.addEventListener("keydown",(e=>{"KeyP"!==e.code||e.repeat||DevTools.toggleDevPanel()})),loadImages(ASSETS,(()=>{game.init(),ShopSystem.init(),DevTools.init()}));